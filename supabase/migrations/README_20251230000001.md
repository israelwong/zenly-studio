# Migraci√≥n: Contract Workflow Fields

**Fecha:** 2024-12-30  
**Archivo:** `20251230000001_add_contract_workflow_fields.sql`  
**Rama:** `251229-studio-promise-contracts`

## üìã Descripci√≥n

Esta migraci√≥n agrega los campos necesarios para implementar el flujo automatizado de generaci√≥n y firma de contratos en promesas, antes de crear eventos.

## üéØ Objetivo

Permitir que los contratos se generen y firmen ANTES de crear el evento, mejorando el flujo comercial:

1. Cliente autoriza cotizaci√≥n
2. Cliente confirma sus datos
3. Contrato se genera (manual o autom√°tico)
4. Cliente firma contrato
5. Studio autoriza y crea evento

## üîß Cambios Implementados

### 1. Campos en `platform_config`

```sql
auto_generate_contract BOOLEAN DEFAULT false
```
- **Prop√≥sito:** Controlar si los contratos se generan autom√°ticamente
- **Default:** `false` (generaci√≥n manual)
- **Uso:** Si es `true`, al confirmar datos se genera contrato autom√°ticamente

```sql
require_contract_before_event BOOLEAN DEFAULT true
```
- **Prop√≥sito:** Requerir contrato firmado antes de crear evento
- **Default:** `true` (requiere contrato)
- **Uso:** Si es `false`, permite crear eventos sin contrato (modo legacy)

### 2. Nuevos Estados de Cotizaci√≥n

**NOTA:** `studio_cotizaciones.status` es de tipo `TEXT`, no ENUM. Los estados se validan a nivel de aplicaci√≥n.

Se documentan 3 nuevos estados para el flujo de contratos:

| Estado | Valor en DB | Descripci√≥n |
|--------|-------------|-------------|
| `CONTRACT_PENDING` | `'contract_pending'` | Cliente debe revisar/confirmar datos antes de generar contrato |
| `CONTRACT_GENERATED` | `'contract_generated'` | Contrato generado, pendiente de firma del cliente |
| `CONTRACT_SIGNED` | `'contract_signed'` | Contrato firmado, pendiente de autorizaci√≥n del studio |

**Flujo completo de estados:**
```
'pendiente' ‚Üí 'compartida' ‚Üí 'pre_autorizada' ‚Üí 'contract_pending' ‚Üí 
'contract_generated' ‚Üí 'contract_signed' ‚Üí 'autorizada'
```

### 3. Campo en `studio_events`

```sql
contract_id TEXT
```
- **Prop√≥sito:** Referencia al contrato que autoriz√≥ la creaci√≥n del evento
- **Foreign Key:** `studio_event_contracts(id)`
- **Nullable:** S√≠ (para eventos legacy sin contrato)
- **√çndice:** S√≠ (`idx_studio_events_contract_id`)

### 4. Campos en `studio_contacts`

```sql
data_confirmed_at TIMESTAMPTZ
data_confirmed_ip INET
```
- **Prop√≥sito:** Registrar cu√°ndo y desde d√≥nde el cliente confirm√≥ sus datos
- **Uso Legal:** Validez del contrato (consentimiento informado)

### 5. Campo en `studio_event_contracts`

```sql
signed_ip INET
```
- **Prop√≥sito:** Registrar IP desde donde se firm√≥ el contrato
- **Uso Legal:** Validez de la firma digital

## üìä Impacto

### Tablas Afectadas
- ‚úÖ `platform_config` (2 columnas nuevas)
- ‚úÖ `studio_cotizaciones` (3 estados nuevos documentados - campo TEXT sin cambios)
- ‚úÖ `studio_events` (1 columna nueva + FK + √≠ndice)
- ‚úÖ `studio_contacts` (2 columnas nuevas)
- ‚úÖ `studio_event_contracts` (1 columna nueva)

### Datos Existentes
- ‚úÖ **Retrocompatible:** Todos los campos son opcionales o tienen defaults
- ‚úÖ **Sin p√©rdida de datos:** No se eliminan columnas ni datos
- ‚úÖ **Eventos legacy:** Funcionan sin contrato (contract_id = NULL)

## üöÄ C√≥mo Aplicar

### Opci√≥n 1: Supabase CLI (Recomendado)
```bash
supabase db push
```

### Opci√≥n 2: SQL Editor en Dashboard
1. Ir a Supabase Dashboard ‚Üí SQL Editor
2. Copiar contenido de `20251230000001_add_contract_workflow_fields.sql`
3. Ejecutar

### Opci√≥n 3: psql
```bash
psql -h [host] -U postgres -d postgres < supabase/migrations/20251230000001_add_contract_workflow_fields.sql
```

## ‚ö†Ô∏è Rollback

Si necesitas revertir los cambios:

```bash
psql -h [host] -U postgres -d postgres < supabase/migrations/20251230000001_add_contract_workflow_fields_rollback.sql
```

**NOTA:** Los valores del enum (`CONTRACT_PENDING`, etc.) NO se pueden eliminar f√°cilmente. Ver comentarios en archivo de rollback.

## ‚úÖ Validaci√≥n Post-Migraci√≥n

Ejecutar estas queries para verificar:

```sql
-- 1. Verificar campos en platform_config
SELECT column_name, data_type, column_default 
FROM information_schema.columns 
WHERE table_name = 'platform_config' 
  AND column_name IN ('auto_generate_contract', 'require_contract_before_event');

-- 2. Verificar que studio_cotizaciones.status es TEXT
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'studio_cotizaciones' 
  AND column_name = 'status';

-- 3. Verificar campo contract_id en eventos
SELECT column_name, data_type, is_nullable 
FROM information_schema.columns 
WHERE table_name = 'studio_events' 
  AND column_name = 'contract_id';

-- 4. Verificar foreign key
SELECT constraint_name, table_name, constraint_type 
FROM information_schema.table_constraints 
WHERE constraint_name = 'fk_studio_events_contract';

-- 5. Verificar √≠ndice
SELECT indexname, indexdef 
FROM pg_indexes 
WHERE indexname = 'idx_studio_events_contract_id';
```

## üìù Pr√≥ximos Pasos

Despu√©s de aplicar esta migraci√≥n:

1. ‚úÖ Actualizar schemas de Prisma
2. ‚úÖ Crear server actions para nuevo flujo
3. ‚úÖ Implementar UI en portal del cliente
4. ‚úÖ Implementar UI en studio
5. ‚úÖ Actualizar l√≥gica de autorizaci√≥n de cotizaciones
6. ‚úÖ Testing end-to-end

## üîó Referencias

- **Issue:** #[n√∫mero]
- **PR:** #[n√∫mero]
- **Rama:** `251229-studio-promise-contracts`
- **Documentaci√≥n:** [Link a docs]

## üë• Autor

Israel Wong - 2024-12-30

